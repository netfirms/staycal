<div class="fixed inset-0 bg-black/40 flex items-center justify-center z-50" role="dialog" aria-modal="true" onclick="(function(e){ if(e.target === e.currentTarget){ document.body.classList.remove('overflow-hidden'); document.getElementById('modal').innerHTML=''; } })(event)">
  <div class="bg-white rounded-xl shadow-lg p-4 w-full max-w-2xl border" onclick="event.stopPropagation();">
    <h3 class="font-semibold mb-2">Edit Booking</h3>
    <form hx-post="/htmx/booking/update" hx-target="#modal" hx-swap="outerHTML" class="grid md:grid-cols-2 gap-3" enctype="multipart/form-data">
      <input type="hidden" name="booking_id" value="{{ booking.id }}" />
      <div>
        <label class="block text-sm font-medium">Room</label>
        <select name="room_id" class="border rounded w-full p-2 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
          {% for r in rooms %}
            <option value="{{ r.id }}" {% if r.id == booking.room_id %}selected{% endif %}>{{ r.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium">Guest name</label>
        <input name="guest_name" class="border rounded w-full p-2 focus:outline-none focus:ring-2 focus:ring-blue-500" value="{{ booking.guest_name }}" required />
      </div>
      <div>
        <label class="block text-sm font-medium">Guest contact</label>
        <input name="guest_contact" class="border rounded w-full p-2 focus:outline-none focus:ring-2 focus:ring-blue-500" value="{{ booking.guest_contact or '' }}" />
      </div>
      <div class="grid grid-cols-2 gap-2 md:col-span-2">
        <div>
          <label class="block text-sm font-medium">Start</label>
          <input type="date" name="start_date" value="{{ booking.start_date.isoformat() }}" class="border rounded w-full p-2 focus:outline-none focus:ring-2 focus:ring-blue-500" required />
        </div>
        <div>
          <label class="block text-sm font-medium">End</label>
          <input type="date" name="end_date" value="{{ booking.end_date.isoformat() }}" class="border rounded w-full p-2 focus:outline-none focus:ring-2 focus:ring-blue-500" required />
        </div>
      </div>
      <div>
        <label class="block text-sm font-medium">Price (THB)</label>
        <input type="number" step="0.01" name="price" class="border rounded w-full p-2 focus:outline-none focus:ring-2 focus:ring-blue-500" value="{{ booking.price if booking.price is not none else '' }}" />
      </div>
      <div>
        <label class="block text-sm font-medium">Status</label>
        <select name="status" class="border rounded w-full p-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
          {% for st in BookingStatus %}
            <option value="{{ st.value }}" {% if booking.status == st %}selected{% endif %}>{{ st.value }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="md:col-span-2">
        <label class="block text-sm font-medium">Notes / Remark</label>
        <textarea name="comment" rows="3" class="border rounded w-full p-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Any special requests, arrival time, etc.">{{ booking.comment or '' }}</textarea>
      </div>
      <div class="md:col-span-2">
        <label class="block text-sm font-medium">Image</label>
        {% if booking.image_url %}
          <img src="{{ booking.image_url }}" alt="Booking image" class="h-24 w-24 object-cover rounded mb-2" />
        {% endif %}
        <input name="image" type="file" accept="image/*" class="border rounded w-full p-2" />
      </div>
      <div class="md:col-span-2 flex gap-2 justify-end">
        <button type="button" class="px-3 py-2 border rounded" onclick="document.body.classList.remove('overflow-hidden'); document.getElementById('modal').innerHTML=''">Cancel</button>
        <button class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Save</button>
      </div>
    </form>
  </div>
  <script>
    (function(){
      try { document.body.classList.add('overflow-hidden'); } catch(_){ }
      function onKey(e){ if(e.key === 'Escape'){ try { document.body.classList.remove('overflow-hidden'); } catch(_){}; var m=document.getElementById('modal'); if(m){ m.innerHTML=''; } } }
      document.addEventListener('keydown', onKey);
      const observer = new MutationObserver(function(){ var m=document.getElementById('modal'); if(m && m.innerHTML.trim()===''){ document.removeEventListener('keydown', onKey); observer.disconnect(); }});
      observer.observe(document.getElementById('modal'), { childList: true });
    })();
  </script>
</div>
