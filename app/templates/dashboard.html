{% extends 'base.html' %}
{% block content %}

{# Header with active homestay and quick actions #}
<div class="mb-4 bg-white border rounded-xl p-4 flex flex-wrap items-center gap-4">
  <div class="flex items-center gap-4 flex-1 min-w-[200px]">
    {% if active and active.image_url %}
      <a href="{{ active.image_url }}" 
         hx-get="/ui/image-modal?image_url={{ active.image_url }}&alt_text={{ active.name|urlencode }}"
         hx-target="body"
         hx-swap="beforeend"
         class="block cursor-pointer">
        <img src="{{ active.image_url }}" alt="{{ active.name }}" class="w-20 h-20 rounded-lg object-cover border" />
      </a>
    {% endif %}
    <div>
      <div class="text-xs text-gray-500">Active Property</div>
      {% if active %}
        <div class="text-xl font-semibold">{{ active.name }}</div>
        <div class="text-sm text-gray-600">{{ active.address }}</div>
      {% else %}
        <div class="text-lg font-semibold text-gray-700">No active property</div>
        <div class="text-sm text-gray-600">Choose or create one to start managing rooms and bookings.</div>
      {% endif %}
    </div>
  </div>
  <div class="flex flex-wrap gap-2">
    <a href="/app/analytics" class="px-3 py-2 border rounded bg-white">Analytics</a>
    <a href="/app/homestays/" class="px-3 py-2 border rounded bg-white">Properties</a>
    <a href="/app/rooms/" class="px-3 py-2 border rounded bg-white">Rooms</a>
    <a href="/app/bookings/" class="px-3 py-2 border rounded bg-white">Bookings</a>
  </div>
</div>

{# Onboarding banner / CTA #}
{% set has_homestay = user and user.homestay_id %}
{% set has_rooms = rooms and rooms|length > 0 %}
<div class="mb-4 rounded-xl border {{ 'bg-emerald-50 border-emerald-200' if has_rooms else ('bg-blue-50 border-blue-200' if has_homestay else 'bg-amber-50 border-amber-200') }} p-3 flex items-center justify-between">
  <div class="text-sm">
    <span class="font-medium">Getting started:</span>
    <span class="ml-2">
      <span class="px-2 py-0.5 rounded {{ 'bg-green-100 text-green-800' if has_homestay else 'bg-gray-100 text-gray-700' }}">1. Property</span>
      <span class="mx-1">→</span>
      <span class="px-2 py-0.5 rounded {{ 'bg-green-100 text-green-800' if has_rooms else ('bg-gray-100 text-gray-700' if has_homestay else 'bg-gray-50 text-gray-400') }}">2. Rooms</span>
      <span class="mx-1">→</span>
      <span class="px-2 py-0.5 rounded {{ 'bg-gray-100 text-gray-700' if has_rooms else 'bg-gray-50 text-gray-400' }}">3. Booking</span>
    </span>
  </div>
  <div class="text-sm">
    {% if not has_homestay %}
      <a href="/app/homestays/" class="text-blue-700">Create or select a property</a>
    {% elif not has_rooms %}
      <a href="/app/rooms/" class="text-blue-700">Add your first room</a>
    {% else %}
      <a href="/app/bookings/new" class="text-blue-700">Create a booking</a>
    {% endif %}
  </div>
</div>

{# Stats cards #}
<div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 mb-4">
    <div class="bg-white rounded-lg border p-4">
        <div class="text-sm text-gray-500">Rooms</div>
        <div class="text-3xl font-semibold">{{ rooms_count if rooms_count else 0 }}</div>
    </div>
    <div class="bg-white rounded-lg border p-4">
        <div class="text-sm text-gray-500">Check-ins Today</div>
        <div class="text-3xl font-semibold">{{ checkins_today|length }}</div>
    </div>
    <div class="bg-white rounded-lg border p-4">
        <div class="text-sm text-gray-500">Check-outs Today</div>
        <div class="text-3xl font-semibold">{{ checkouts_today|length }}</div>
    </div>
    <div class="bg-white rounded-lg border p-4">
        <div class="text-sm text-gray-500">Upcoming Bookings</div>
        <div class="text-3xl font-semibold">{{ upcoming_count }}</div>
    </div>
</div>

<div class="grid lg:grid-cols-3 gap-4 mb-4">
    <div class="bg-white rounded-lg border p-4">
        <h3 class="font-medium mb-2">This Month ({{ analytics.month_start.strftime('%B') }})</h3>
        <div class="grid grid-cols-2 gap-4">
            <div class="p-3 rounded border bg-gray-50">
                <div class="text-xs text-gray-600">Bookings</div>
                <div class="text-lg font-semibold">{{ analytics.monthly_bookings }}</div>
            </div>
            <div class="p-3 rounded border bg-gray-50">
                <div class="text-xs text-gray-600">Revenue</div>
                <div class="text-lg font-semibold">{{ user.currency|currency_symbol }}{{ '%.2f'|format(analytics.monthly_revenue) }}</div>
            </div>
        </div>
    </div>
    <div class="lg:col-span-2 bg-white rounded-lg border p-4">
        <h3 class="font-medium mb-2">Key Metrics (This Month)</h3>
        <div class="grid grid-cols-3 gap-4">
            <div class="p-3 rounded border bg-gray-50">
                <div class="text-xs text-gray-600">Occupancy Rate</div>
                <div class="text-lg font-semibold">{{ '%.2f'|format(analytics.occupancy_rate) }}%</div>
            </div>
            <div class="p-3 rounded border bg-gray-50">
                <div class="text-xs text-gray-600">Avg. Daily Rate (ADR)</div>
                <div class="text-lg font-semibold">{{ user.currency|currency_symbol }}{{ '%.2f'|format(analytics.adr) }}</div>
            </div>
            <div class="p-3 rounded border bg-gray-50">
                <div class="text-xs text-gray-600">Revenue Per Room (RevPAR)</div>
                <div class="text-lg font-semibold">{{ user.currency|currency_symbol }}{{ '%.2f'|format(analytics.revpar) }}</div>
            </div>
        </div>
    </div>
</div>


{# Today operations lists #}
{% if checkins_today or checkouts_today %}
<div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
  <div class="bg-white p-4 rounded shadow-sm border">
    <h2 class="font-medium mb-2">Check-ins Today ({{ checkins_today|length }})</h2>
    {% if checkins_today %}
      <ul class="divide-y text-sm">
        {% for b in checkins_today %}
          <li class="py-2 flex items-center justify-between">
            <div>
              <div class="font-medium">{{ b.guest_name }}</div>
              <div class="text-gray-600">Room: {{ rooms_map[b.room_id].name if rooms_map.get(b.room_id) else 'Room #' ~ b.room_id }}</div>
              <div class="text-xs text-gray-500">{{ b.start_date.isoformat() }} → {{ b.end_date.isoformat() }}</div>
            </div>
            <a href="/app/bookings/{{ b.id }}/edit?return_url=/app" class="text-blue-600 text-sm">Manage</a>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p class="text-sm text-gray-600">No check-ins today.</p>
    {% endif %}
  </div>
  <div class="bg-white p-4 rounded shadow-sm border">
    <h2 class="font-medium mb-2">Check-outs Today ({{ checkouts_today|length }})</h2>
    {% if checkouts_today %}
      <ul class="divide-y text-sm">
        {% for b in checkouts_today %}
          <li class="py-2 flex items-center justify-between">
            <div>
              <div class="font-medium">{{ b.guest_name }}</div>
              <div class="text-gray-600">Room: {{ rooms_map[b.room_id].name if rooms_map.get(b.room_id) else 'Room #' ~ b.room_id }}</div>
              <div class="text-xs text-gray-500">{{ b.start_date.isoformat() }} → {{ b.end_date.isoformat() }}</div>
            </div>
            <a href="/app/bookings/{{ b.id }}/edit?return_url=/app" class="text-blue-600 text-sm">Manage</a>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p class="text-sm text-gray-600">No check-outs today.</p>
    {% endif %}
  </div>
</div>
{% endif %}

{# Status legend #}
<div class="mb-3 text-xs text-gray-600 flex flex-wrap items-center gap-3">
  <span class="inline-flex items-center gap-1"><span class="w-3 h-3 inline-block rounded-sm bg-yellow-300"></span> Tentative</span>
  <span class="inline-flex items-center gap-1"><span class="w-3 h-3 inline-block rounded-sm bg-green-300"></span> Confirmed</span>
  <span class="inline-flex items-center gap-1"><span class="w-3 h-3 inline-block rounded-sm bg-blue-300"></span> Checked-in</span>
  <span class="inline-flex items-center gap-1"><span class="w-3 h-3 inline-block rounded-sm bg-gray-300"></span> Checked-out</span>
  <span class="inline-flex items-center gap-1"><span class="w-3 h-3 inline-block rounded-sm bg-orange-300"></span> OTA (read-only)</span>
  <span class="text-gray-400">· Click a booking to edit; drag on a calendar to create.</span>
</div>

{# Rooms calendars #}
{% if not has_homestay %}
  <div class="bg-white border rounded-xl p-6 text-center text-gray-700">
    <div class="text-lg font-medium mb-1">You're almost there</div>
    <p class="text-sm">Create or select a property to start managing rooms and bookings.</p>
    <a href="/app/homestays/" class="mt-3 inline-block px-4 py-2 bg-blue-600 text-white rounded">Manage Properties</a>
  </div>
{% else %}
  {% if rooms %}
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      {% for r in rooms %}
      <div class="bg-white border rounded-xl p-3">
        <details open>
          <summary class="cursor-pointer list-none flex items-center justify-between">
            <div class="flex items-center gap-2">
              {% if r.image_url %}
                <a href="{{ r.image_url }}" 
                   hx-get="/ui/image-modal?image_url={{ r.image_url }}&alt_text={{ r.name|urlencode }}"
                   hx-target="body"
                   hx-swap="beforeend"
                   class="block cursor-pointer">
                  <img src="{{ r.image_url }}" alt="{{ r.name }}" class="w-8 h-8 rounded object-cover border" />
                </a>
              {% endif %}
              <div class="font-medium">{{ r.name }} <span class="text-xs text-gray-500">(cap {{ r.capacity }})</span></div>
            </div>
            <div class="text-sm"><a href="/app/bookings/new?room_id={{ r.id }}&return_url=/app" class="text-green-700">New Booking</a></div>
          </summary>
          <div class="mt-3">
            <div id="cal-{{ r.id }}" class="fc-container border rounded"></div>
          </div>
        </details>
      </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="bg-white border rounded-xl p-6 text-center text-gray-700">
      <div class="text-lg font-medium mb-1">No rooms yet</div>
      <p class="text-sm">Add your first room to start taking bookings.</p>
      <a href="/app/rooms/" class="mt-3 inline-block px-4 py-2 bg-blue-600 text-white rounded">Add Room</a>
    </div>
  {% endif %}
{% endif %}

<script>
  (function(){
    if (!window.FullCalendar) { return; }
    const calendars = {};
    const rooms = [{% for r in rooms %}{ id: {{ r.id }}, name: {{ r.name|tojson|safe }} },{% endfor %}];
    const initialDate = '{{ today.isoformat() }}';

    function initCalendar(roomId){
      const el = document.getElementById('cal-' + roomId);
      if (!el) return;
      const calendar = new FullCalendar.Calendar(el, {
        initialDate: initialDate,
        height: 'auto',
        headerToolbar: {
          left: 'prev,next today',
          center: 'title',
          right: 'dayGridMonth,listMonth'
        },
        navLinks: false,
        selectable: true,
        selectMirror: true,
        dayMaxEvents: true,
        events: function(info, success, failure){
          fetch(`/htmx/calendar/events?room_id=${roomId}&start=${info.startStr}&end=${info.endStr}`)
            .then(r => {
              if (!r.ok) throw new Error('Failed to load events');
              return r.json();
            })
            .then(events => success(events))
            .catch(err => failure(err));
        },
        select: function(info){
          window.location.href = `/app/bookings/new?room_id=${roomId}&start_date=${info.startStr}&end_date=${info.endStr}&return_url=/app`;
        },
        eventClick: function(info){
          const id = info.event.id;
          if (!id || String(id).startsWith('ota-')) return;
          window.location.href = `/app/bookings/${id}/edit?return_url=/app`;
        }
      });
      calendar.render();
      calendars[roomId] = calendar;
    }

    rooms.forEach(r => initCalendar(r.id));
  })();
</script>
{% endblock %}
