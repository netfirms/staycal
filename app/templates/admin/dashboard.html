{% extends 'base.html' %}
{% block content %}
<div class="mb-4 flex items-center justify-between">
  <h1 class="text-2xl font-semibold">Admin</h1>
  <div class="flex gap-2">
    <a href="/admin/cloudinary" class="px-3 py-2 border rounded bg-white hover:bg-gray-50">Cloudinary Settings</a>
    <a href="/admin/plans" class="px-3 py-2 border rounded bg-white hover:bg-gray-50">Manage Plans</a>
  </div>
</div>

{# Subscription Pricing quick edit #}
<div class="bg-white p-4 rounded-xl shadow-sm border mb-4">
  <div class="flex items-center justify-between mb-2">
    <h2 class="font-medium">Subscription Pricing</h2>
    {% if pricing_saved %}
      <span class="text-xs px-2 py-1 rounded bg-green-100 text-green-800">Saved</span>
    {% elif pricing_error %}
      <span class="text-xs px-2 py-1 rounded bg-red-100 text-red-800">Invalid values</span>
    {% endif %}
  </div>
  <form method="post" action="/admin/pricing" class="grid md:grid-cols-4 gap-3 items-end">
    <div>
      <label class="block text-xs text-gray-600">Basic Monthly (THB)</label>
      <input name="basic_monthly" type="number" step="0.01" class="border rounded p-2 w-full" value="{{ '%.2f'|format(pricing.basic_monthly|float) }}" />
    </div>
    <div>
      <label class="block text-xs text-gray-600">Basic Yearly (THB)</label>
      <input name="basic_yearly" type="number" step="0.01" class="border rounded p-2 w-full" value="{{ '%.2f'|format(pricing.basic_yearly|float) }}" />
    </div>
    <div>
      <label class="block text-xs text-gray-600">Pro Monthly (THB)</label>
      <input name="pro_monthly" type="number" step="0.01" class="border rounded p-2 w-full" value="{{ '%.2f'|format(pricing.pro_monthly|float) }}" />
    </div>
    <div>
      <label class="block text-xs text-gray-600">Pro Yearly (THB)</label>
      <input name="pro_yearly" type="number" step="0.01" class="border rounded p-2 w-full" value="{{ '%.2f'|format(pricing.pro_yearly|float) }}" />
    </div>
    <div class="md:col-span-4 text-right">
      <button class="px-4 py-2 bg-blue-600 text-white rounded">Save Pricing</button>
    </div>
  </form>
</div>

{% if analytics %}
<div class="grid md:grid-cols-3 lg:grid-cols-6 gap-3 mb-4">
  <div class="bg-white p-3 rounded-xl border shadow-sm">
    <div class="text-xs text-gray-500">Users</div>
    <div class="text-xl font-semibold">{{ analytics.users_count }}</div>
  </div>
  <div class="bg-white p-3 rounded-xl border shadow-sm">
    <div class="text-xs text-gray-500">Properties</div>
    <div class="text-xl font-semibold">{{ analytics.homestays_count }}</div>
  </div>
  <div class="bg-white p-3 rounded-xl border shadow-sm">
    <div class="text-xs text-gray-500">Rooms</div>
    <div class="text-xl font-semibold">{{ analytics.rooms_count }}</div>
  </div>
  <div class="bg-white p-3 rounded-xl border shadow-sm">
    <div class="text-xs text-gray-500">Bookings</div>
    <div class="text-xl font-semibold">{{ analytics.bookings_count }}</div>
  </div>
  <div class="bg-white p-3 rounded-xl border shadow-sm">
    <div class="text-xs text-gray-500">Check-ins Today</div>
    <div class="text-xl font-semibold">{{ analytics.checkins_today }}</div>
  </div>
  <div class="bg-white p-3 rounded-xl border shadow-sm">
    <div class="text-xs text-gray-500">Check-outs Today</div>
    <div class="text-xl font-semibold">{{ analytics.checkouts_today }}</div>
  </div>
</div>

<div class="grid lg:grid-cols-3 gap-4 mb-6">
  <div class="bg-white p-4 rounded-xl shadow-sm border">
    <h2 class="font-medium mb-1">This Month</h2>
    <div class="text-sm text-gray-500 mb-3">From {{ analytics.month_start }} to now</div>
    <div class="grid grid-cols-2 gap-3">
      <div class="p-3 rounded border bg-gray-50">
        <div class="text-xs text-gray-600">Bookings</div>
        <div class="text-lg font-semibold">{{ analytics.monthly_bookings }}</div>
      </div>
      <div class="p-3 rounded border bg-gray-50">
        <div class="text-xs text-gray-600">Revenue (THB)</div>
        <div class="text-lg font-semibold">฿{{ '%.2f'|format(analytics.monthly_revenue) }}</div>
      </div>
    </div>
  </div>

  <div class="bg-white p-4 rounded-xl shadow-sm border">
    <h2 class="font-medium mb-2">Booking Status</h2>
    <ul class="text-sm divide-y">
      {% for key, val in analytics.status_counts.items() %}
      <li class="py-1 flex items-center justify-between">
        <div class="capitalize">{{ key.replace('_',' ') }}</div>
        <div class="font-medium">{{ val }}</div>
      </li>
      {% endfor %}
    </ul>
  </div>

  <div class="bg-white p-4 rounded-xl shadow-sm border">
    <h2 class="font-medium mb-2">Plan Distribution</h2>
    <ul class="text-sm divide-y">
      {% for key, val in analytics.plan_counts.items() %}
      <li class="py-1 flex items-center justify-between">
        <div class="uppercase">{{ key }}</div>
        <div class="font-medium">{{ val }}</div>
      </li>
      {% endfor %}
    </ul>
  </div>
</div>

<div class="grid md:grid-cols-2 gap-4 mb-6">
  <div class="bg-white p-4 rounded-xl shadow-sm border">
    <h2 class="font-medium mb-2">Recent Signups</h2>
    <ul class="text-sm divide-y">
      {% for u in analytics.recent_users %}
      <li class="py-2 flex items-center justify-between">
        <div>{{ u.email }}</div>
        <div class="text-xs text-gray-500">{{ u.created_at }}</div>
      </li>
      {% else %}
      <li class="py-2 text-gray-500">No users.</li>
      {% endfor %}
    </ul>
  </div>
  <div class="bg-white p-4 rounded-xl shadow-sm border">
    <h2 class="font-medium mb-2">Recent Bookings</h2>
    <ul class="text-sm divide-y">
      {% for b in analytics.recent_bookings %}
      <li class="py-2 flex items-center justify-between">
        <div>
          <div class="font-medium">{{ b.guest_name }}</div>
          <div class="text-xs text-gray-500">{{ b.start_date }} → {{ b.end_date }} (status: {{ b.status.value }})</div>
        </div>
        <div class="text-xs text-gray-700">{% if b.price is not none %}฿{{ '%.2f'|format(b.price|float) }}{% else %}-{% endif %}</div>
      </li>
      {% else %}
      <li class="py-2 text-gray-500">No bookings.</li>
      {% endfor %}
    </ul>
  </div>
</div>
{% endif %}

{# Plans & Subscriptions quick management #}
<div class="bg-white p-4 rounded-xl shadow-sm border mb-6">
  <div class="flex items-center justify-between mb-2">
    <h2 class="font-medium">Plans & Subscriptions</h2>
    <a href="/admin/plans" class="text-sm text-blue-700 hover:underline">Open full Plans page</a>
  </div>
  <div class="overflow-x-auto">
    <table class="w-full text-sm">
      <thead>
        <tr class="text-left border-b bg-gray-50">
          <th class="py-2 px-2">User</th>
          <th class="py-2 px-2">Plan</th>
          <th class="py-2 px-2">Status</th>
          <th class="py-2 px-2">Expires</th>
          <th class="py-2 px-2"></th>
        </tr>
      </thead>
      <tbody class="divide-y">
        {% for u in users %}
        {% set sub = subs_map.get(u.id) if subs_map else None %}
        <tr>
          <td class="py-2 px-2">
            <div class="font-medium">{{ u.email }}</div>
            <div class="text-xs text-gray-500">id: {{ u.id }} · role: {{ u.role }}</div>
          </td>
          <td class="py-2 px-2">{{ sub.plan_name.value if sub else '-' }}</td>
          <td class="py-2 px-2">{{ sub.status.value if sub else '-' }}</td>
          <td class="py-2 px-2">{{ sub.expires_at.date().isoformat() if sub and sub.expires_at else '-' }}</td>
          <td class="py-2 px-2 text-right">
            <details class="inline-block">
              <summary class="cursor-pointer px-3 py-1.5 border rounded bg-white hover:bg-gray-50">Edit</summary>
              <div class="mt-2 p-3 border rounded bg-gray-50">
                <form method="post" action="/admin/plans/save" class="grid md:grid-cols-4 gap-2 items-end">
                  <input type="hidden" name="owner_id" value="{{ u.id }}" />
                  <input type="hidden" name="return_to" value="/admin" />
                  <div>
                    <label class="block text-xs text-gray-600">Plan</label>
                    <select name="plan_name" class="border rounded p-1">
                      {% for p in PlanName %}
                        <option value="{{ p.value }}" {% if sub and sub.plan_name == p %}selected{% endif %}>{{ p.value }}</option>
                      {% endfor %}
                    </select>
                  </div>
                  <div>
                    <label class="block text-xs text-gray-600">Status</label>
                    <select name="status" class="border rounded p-1">
                      {% for s in SubscriptionStatus %}
                        <option value="{{ s.value }}" {% if sub and sub.status == s %}selected{% endif %}>{{ s.value }}</option>
                      {% endfor %}
                    </select>
                  </div>
                  <div>
                    <label class="block text-xs text-gray-600">Expires At</label>
                    <input type="date" name="expires_at" class="border rounded p-1" value="{{ sub.expires_at.date().isoformat() if sub and sub.expires_at else '' }}" />
                  </div>
                  <div class="text-right">
                    <button class="px-3 py-2 bg-blue-600 text-white rounded">Save</button>
                  </div>
                </form>
              </div>
            </details>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
  <div class="bg-white p-4 rounded-xl shadow-sm border">
    <h2 class="font-medium mb-2">Users</h2>
    <div class="overflow-auto max-h-80">
      <table class="w-full text-sm">
        <thead>
          <tr class="text-left border-b bg-gray-50">
            <th class="py-2 px-2">Email</th>
            <th class="py-2 px-2">Role</th>
          </tr>
        </thead>
        <tbody class="divide-y">
          {% for u in users %}
          <tr>
            <td class="py-2 px-2">{{ u.email }}</td>
            <td class="py-2 px-2">{{ u.role }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  <div class="bg-white p-4 rounded-xl shadow-sm border">
    <h2 class="font-medium mb-2">Properties</h2>
    <div class="overflow-auto max-h-80">
      <table class="w-full text-sm">
        <thead>
          <tr class="text-left border-b bg-gray-50">
            <th class="py-2 px-2">Name</th>
            <th class="py-2 px-2">Owner ID</th>
          </tr>
        </thead>
        <tbody class="divide-y">
          {% for h in homestays %}
          <tr>
            <td class="py-2 px-2">{{ h.name }}</td>
            <td class="py-2 px-2">{{ h.owner_id }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  <div class="bg-white p-4 rounded-xl shadow-sm border">
    <h2 class="font-medium mb-2">Subscriptions</h2>
    <div class="overflow-auto max-h-80">
      <table class="w-full text-sm">
        <thead>
          <tr class="text-left border-b bg-gray-50">
            <th class="py-2 px-2">Owner</th>
            <th class="py-2 px-2">Plan</th>
            <th class="py-2 px-2">Status</th>
          </tr>
        </thead>
        <tbody class="divide-y">
          {% for s in subs %}
          <tr>
            <td class="py-2 px-2">{{ s.owner_id }}</td>
            <td class="py-2 px-2">{{ s.plan_name.value }}</td>
            <td class="py-2 px-2">{{ s.status.value }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endblock %}