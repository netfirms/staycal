{% extends 'base.html' %}
{% block content %}
<h1 class="text-2xl font-semibold mb-4">Admin • Plans & Subscriptions</h1>
<p class="text-sm text-gray-600 mb-4">Assign, update, or remove a user's subscription.</p>

<div class="bg-white p-4 rounded-xl shadow-sm border">
  <div class="overflow-x-auto">
    <table class="w-full text-sm">
      <thead>
        <tr class="text-left border-b bg-gray-50">
          <th class="py-2 px-2">User</th>
          <th class="py-2 px-2">Current Plan</th>
          <th class="py-2 px-2">Status</th>
          <th class="py-2 px-2">Expires At</th>
          <th class="py-2 px-2 text-right">Actions</th>
        </tr>
      </thead>
      <tbody class="divide-y">
        {% for u in users %}
        <tr>
          <td class="py-2 px-2">
            <div class="font-medium">{{ u.email }}</div>
            <div class="text-xs text-gray-500">id: {{ u.id }} · role: {{ u.role }}</div>
          </td>
          {% set sub = subs_map.get(u.id) %}
          <td class="py-2 px-2">{{ sub.plan.name if sub and sub.plan else '-' }}</td>
          <td class="py-2 px-2">{{ sub.status.value if sub else '-' }}</td>
          <td class="py-2 px-2">{{ sub.expires_at.date().isoformat() if sub and sub.expires_at else '-' }}</td>
          <td class="py-2 px-2 text-right">
            {% if sub %}
              <details class="inline-block">
                <summary class="cursor-pointer px-3 py-1.5 border rounded bg-white hover:bg-gray-50">Edit</summary>
                <div class="mt-2 p-3 border rounded bg-gray-50 text-left">
                  <form method="post" action="/admin/plans/save" class="grid md:grid-cols-4 gap-2 items-end">
                    <input type="hidden" name="owner_id" value="{{ u.id }}" />
                    <input type="hidden" name="return_to" value="/admin/plans" />
                    <div>
                      <label class="block text-xs text-gray-600">Plan</label>
                      <select name="plan_id" class="border rounded p-1">
                        {% for p in plans %}<option value="{{ p.id }}" {% if sub and sub.plan_id == p.id %}selected{% endif %}>{{ p.name }}</option>{% endfor %}
                      </select>
                    </div>
                    <div>
                      <label class="block text-xs text-gray-600">Status</label>
                      <select name="status" class="border rounded p-1">
                        {% for s in SubscriptionStatus %}<option value="{{ s.value }}" {% if sub and sub.status == s %}selected{% endif %}>{{ s.value }}</option>{% endfor %}
                      </select>
                    </div>
                    <div>
                      <label class="block text-xs text-gray-600">Expires At</label>
                      <input type="date" name="expires_at" class="border rounded p-1" value="{{ sub.expires_at.date().isoformat() if sub and sub.expires_at else '' }}" />
                    </div>
                    <div class="text-right">
                      <button class="px-3 py-2 bg-blue-600 text-white rounded">Save</button>
                    </div>
                  </form>
                </div>
              </details>
              <form method="post" action="/admin/plans/{{ sub.id }}/delete" class="inline-block ml-2" onsubmit="return confirm('Are you sure you want to delete this subscription?');">
                <button type="submit" class="px-3 py-1.5 border rounded bg-red-100 text-red-700 hover:bg-red-200">Delete</button>
              </form>
            {% else %}
              <details class="inline-block">
                <summary class="cursor-pointer px-3 py-1.5 border rounded bg-green-100 text-green-700 hover:bg-green-200">Add Subscription</summary>
                <div class="mt-2 p-3 border rounded bg-gray-50 text-left">
                  <form method="post" action="/admin/plans/save" class="grid md:grid-cols-4 gap-2 items-end">
                    <input type="hidden" name="owner_id" value="{{ u.id }}" />
                    <input type="hidden" name="return_to" value="/admin/plans" />
                    <div>
                      <label class="block text-xs text-gray-600">Plan</label>
                      <select name="plan_id" class="border rounded p-1">
                        {% for p in plans %}<option value="{{ p.id }}">{{ p.name }}</option>{% endfor %}
                      </select>
                    </div>
                    <div>
                      <label class="block text-xs text-gray-600">Status</label>
                      <select name="status" class="border rounded p-1">
                        {% for s in SubscriptionStatus %}<option value="{{ s.value }}">{{ s.value }}</option>{% endfor %}
                      </select>
                    </div>
                    <div>
                      <label class="block text-xs text-gray-600">Expires At</label>
                      <input type="date" name="expires_at" class="border rounded p-1" value="" />
                    </div>
                    <div class="text-right">
                      <button class="px-3 py-2 bg-blue-600 text-white rounded">Save</button>
                    </div>
                  </form>
                </div>
              </details>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<div class="mt-4">
  <a href="/admin/" class="px-3 py-2 border rounded bg-white">Back to Admin</a>
</div>
{% endblock %}
